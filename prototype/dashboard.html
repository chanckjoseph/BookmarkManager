<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Bookmark Manager</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;600;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --accent: #38bdf8;
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --sidebar-bg: rgba(15, 23, 42, 0.9);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-color: #f1f5f9;
            --text-dim: #94a3b8;
            --accent-glow: rgba(56, 189, 248, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            background-image:
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.1) 0, transparent 40%),
                radial-gradient(at 100% 100%, rgba(56, 189, 248, 0.05) 0, transparent 40%);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            padding: 2.5rem;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            flex: 1;
        }

        h2 {
            color: var(--accent);
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Profile & Import Section */
        .profile-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .profile-item code {
            font-size: 0.75rem;
            opacity: 0.7;
            display: block;
            margin: 0.5rem 0;
            word-break: break-all;
        }

        /* Tables & Alignment */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        th {
            text-align: left;
            padding: 1rem;
            color: var(--text-dim);
            font-family: 'Outfit', sans-serif;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--glass-border);
            font-weight: 600;
        }

        td {
            padding: 1.25rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            vertical-align: middle;
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.01);
        }

        .col-title {
            width: 45%;
        }

        .col-folder {
            width: 15%;
        }

        .col-tags {
            width: 20%;
        }

        .col-source {
            width: 10%;
        }

        .col-status {
            width: 10%;
        }

        .source-badge {
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 6px;
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent);
            border: 1px solid rgba(56, 189, 248, 0.2);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .btn {
            background: var(--accent);
            color: var(--bg);
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.8rem;
            transition: all 0.2s;
            font-family: 'Outfit', sans-serif;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.2);
            background: #fff;
        }

        .search-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            padding: 1.5rem 2.5rem;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .search-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            padding: 14px 24px;
            border-radius: 14px;
            font-size: 1rem;
            color: #fff;
            transition: all 0.3s;
            font-family: 'Inter', sans-serif;
        }

        .search-input:focus {
            border-color: var(--accent);
            background: rgba(0, 0, 0, 0.3);
            box-shadow: 0 0 0 4px rgba(56, 189, 248, 0.1);
            outline: none;
        }

        .tag-pill {
            background: rgba(56, 189, 248, 0.08);
            color: var(--accent);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            border: 1px solid rgba(56, 189, 248, 0.15);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-weight: 500;
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.5;
            font-size: 1rem;
            line-height: 1;
        }

        .tag-remove:hover {
            opacity: 1;
            color: #ef4444;
        }

        .tag-add-btn {
            background: rgba(255, 255, 255, 0.03);
            border: 1px dashed var(--glass-border);
            color: var(--text-dim);
            border-radius: 8px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .tag-add-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(56, 189, 248, 0.05);
        }

        /* Layout Refactor: UX Excellence */
        body {
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        .global-nav {
            width: 70px;
            background: #0f172a;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 2rem;
            gap: 2rem;
            flex-shrink: 0;
            z-index: 1000;
        }

        .nav-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            cursor: pointer;
            text-decoration: none;
            font-size: 1.2rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-icon:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            transform: scale(1.05);
        }

        .nav-icon.active {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(56, 189, 248, 0.2);
        }

        .layout-container {
            display: flex;
            flex: 1;
            height: 100vh;
            overflow: hidden;
        }

        .context-sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 2rem 1.5rem;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .sidebar-title {
            font-family: 'Outfit', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 2rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--glass-border);
        }

        .main-stage {
            flex: 1;
            overflow-y: auto;
            padding: 3rem;
            background: rgba(15, 23, 42, 0.3);
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
        }

        /* Minimalist Table & Alignment */
        .search-area {
            margin-bottom: 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            background: rgba(255, 255, 255, 0.02);
            padding: 1.5rem 2rem;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .search-container {
            flex: 1;
            max-width: 600px;
        }

        .search-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            padding: 14px 24px;
            border-radius: 14px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.1);
        }

        /* Collapsible Tree Styles */
        .tree-node {
            margin-bottom: 4px;
        }

        .tree-label {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #94a3b8;
            font-size: 0.9rem;
            gap: 10px;
        }

        .tree-label:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .tree-label.active {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent);
            font-weight: 600;
        }

        .tree-toggle {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            opacity: 0.5;
            transition: transform 0.2s;
        }

        .tree-toggle.expanded {
            transform: rotate(90deg);
        }

        .tree-children {
            padding-left: 20px;
            display: none;
            border-left: 1px solid rgba(255, 255, 255, 0.05);
            margin-left: 7px;
        }

        .tree-children.visible {
            display: block;
        }

        h2.sidebar-title {
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-bottom: 1.5rem;
            margin-top: 0;
        }

        /* Bookmark Bar Styles */
        .bookmark-bar {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.8) 100%);
            border-bottom: 1px solid var(--border);
            padding: 0 2rem;
            gap: 0.5rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(20px);
            margin: -2rem -2rem 1.5rem -2rem;
            height: 48px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
        }

        .bar-item {
            position: relative;
            cursor: pointer;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #cbd5e1;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            height: 32px;
        }

        .bar-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            transform: translateY(-1px);
        }

        .bar-item.active {
            color: var(--accent);
            background: rgba(56, 189, 248, 0.1);
            font-weight: 600;
            box-shadow: inset 0 0 15px rgba(56, 189, 248, 0.05);
        }

        /* Dropdown Styles */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid var(--border);
            border-radius: 12px;
            min-width: 240px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.05);
            display: none;
            flex-direction: column;
            padding: 0.6rem;
            z-index: 1100;
            animation: slideDown 0.2s cubic-bezier(0, 0, 0.2, 1);
            backdrop-filter: blur(15px);
            margin-top: 5px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .bar-item:hover>.dropdown-menu {
            display: flex;
        }

        .dropdown-item {
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            color: #cbd5e1;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            position: relative;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: var(--accent);
            color: #000;
            font-weight: 600;
        }

        .dropdown-item .submenu {
            position: absolute;
            left: 100%;
            top: -5px;
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid var(--border);
            border-radius: 12px;
            min-width: 240px;
            display: none;
            flex-direction: column;
            padding: 0.6rem;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
            animation: slideRight 0.2s cubic-bezier(0, 0, 0.2, 1);
            margin-left: 5px;
        }

        /* Table Design: Fixed alignment */
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            /* Force alignment */
        }

        th,
        td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        th {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            font-weight: 600;
        }

        /* Column Widths */
        .col-title {
            width: 35%;
        }

        .col-folder {
            width: 20%;
            color: #64748b;
            font-size: 0.8rem;
        }

        .col-tags {
            width: 20%;
        }

        .col-source {
            width: 15%;
        }

        .col-status {
            width: 5%;
        }

        .col-history {
            width: 5%;
            text-align: center;
        }

        .tag-pill {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .history-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 1.1rem;
            transition: color 0.2s;
            padding: 4px;
            border-radius: 4px;
        }

        .history-btn:hover {
            color: var(--accent);
            background: rgba(56, 189, 248, 0.1);
        }

        .history-item {
            padding: 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            border-color: rgba(56, 189, 248, 0.3);
        }
    </style>
</head>

<body>
    <nav class="global-nav">
        <a href="/dashboard" class="nav-icon active" title="Dashboard">üè†</a>
        <a href="/tools" class="nav-icon" title="Tools">üõ†Ô∏è</a>
        <a href="/audit-history" class="nav-icon" title="History">üìú</a>
    </nav>

    <div class="layout-container">
        <!-- Context Sidebar: Folders -->
        <aside class="context-sidebar">
            <h2 class="sidebar-title">Collections</h2>
            <div id="folder-tree-container">
                <div id="folder-tree">
                    <!-- Unified tree injected here -->
                </div>
            </div>
        </aside>

        <!-- Main Stage -->
        <main class="main-stage">
            <header class="search-area">
                <div class="search-container">
                    <input type="text" class="search-input" id="search-input" placeholder="Search your library..."
                        oninput="handleSearch(this.value)">
                </div>
                <button class="btn" onclick="refreshList()">Refresh</button>
            </header>

            <section class="glass-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2>Library</h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th class="col-title">Title & URL</th>
                            <th class="col-folder">Folder Path</th>
                            <th class="col-tags">Tags</th>
                            <th class="col-source">Source</th>
                            <th class="col-status">Status</th>
                            <th class="col-history"></th>
                        </tr>
                    </thead>
                    <tbody id="bookmark-table-body">
                        <!-- Data injected here -->
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <!-- History Modal -->
    <div id="history-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center;">
        <div class="glass-card"
            style="width: 500px; max-height: 80vh; display:flex; flex-direction:column; background: #0f172a; padding: 1.5rem;">
            <div
                style="display:flex; justify-content:space-between; margin-bottom:1.5rem; border-bottom:1px solid var(--border); padding-bottom:1rem;">
                <h2 style="margin:0; border:none; font-family: 'Outfit';">Version History</h2>
                <button onclick="closeHistory()"
                    style="background:none; border:none; color:#fff; cursor:pointer; font-size:1.2rem;">‚úï</button>
            </div>
            <div id="history-list" style="flex:1; overflow-y:auto; padding-right: 5px;">
                <!-- History items go here -->
            </div>
        </div>
    </div>


    <script>
        const API_BASE = '{{ API_BASE_URL }}';
        let searchDebounce;

        async function init() {
            refreshList();
        }

        function handleSearch(query) {
            clearTimeout(searchDebounce);
            searchDebounce = setTimeout(() => {
                refreshListDatasource(query);
            }, 300);
        }

        async function checkPendingSyncs() {
            try {
                // This dashboard doesn't have a container for badges by default, 
                // but we should keep the logic if we want to show a 'Sync Required' notice.
                const res = await fetch(`${API_BASE}/sync/batches`);
                const data = await res.json();
                if (data.batches && data.batches.length > 0) {
                    console.log("Pending sync batches available.");
                }
            } catch (e) { console.error("Sync check failed", e); }
        }

        async function removeTag(bmId, tagId) {
            if (!confirm("Remove this tag?")) return;
            try {
                const res = await fetch(`${API_BASE}/bookmarks/${bmId}/tags/${tagId}`, { method: 'DELETE' });
                if (res.ok) refreshList();
            } catch (e) { alert("Delete failed"); }
        }

        function promptAddTag(bmId) {
            const name = prompt("Enter tag name:");
            if (name) addTag(bmId, name);
        }

        async function addTag(bmId, name) {
            try {
                const res = await fetch(`${API_BASE}/bookmarks/${bmId}/tags`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });
                if (res.ok) refreshList();
                else alert("Tag already exists or failed to add.");
            } catch (e) { alert("Add failed"); }
        }

        let state = {
            allBookmarks: [],
            currentFolder: "All Bookmarks"
        };

        // --- Folder Tree Logic ---

        function buildFolderTree(bookmarks) {
            const root = {
                "All Bookmarks": { _children: {}, _isRoot: true }
            };

            bookmarks.forEach(bm => {
                const folder = bm.folder || "";
                const parts = folder.split(' > ').filter(p => p.trim() !== "");
                let current = root["All Bookmarks"]._children;

                parts.forEach(part => {
                    if (!current[part]) {
                        current[part] = { _children: {} };
                    }
                    current = current[part]._children;
                });
            });
            return root;
        }

        function renderCollapsibleTree(node, container, path = "") {
            const folders = Object.keys(node).sort();

            folders.forEach(folderName => {
                const isSystemRoot = node[folderName]._isRoot;
                // Path used for filtering should NOT include the virtual "All Bookmarks" root
                const fullPath = isSystemRoot ? folderName : (path && path !== "All Bookmarks" ? `${path} > ${folderName}` : folderName);
                const children = node[folderName]._children;
                const hasChildren = Object.keys(children).length > 0;

                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'tree-node';

                const labelDiv = document.createElement('div');
                labelDiv.className = 'tree-label';
                if (state.currentFolder === fullPath) labelDiv.classList.add('active');

                const toggle = document.createElement('span');
                toggle.className = 'tree-toggle';
                if (hasChildren) {
                    toggle.innerText = '‚ñ∂';
                    toggle.onclick = (e) => {
                        e.stopPropagation();
                        toggle.classList.toggle('expanded');
                        const childContainer = nodeDiv.querySelector('.tree-children');
                        childContainer.classList.toggle('visible');
                    };
                }

                const icon = document.createElement('span');
                icon.className = 'folder-icon';
                icon.innerText = 'üìÇ';

                const text = document.createElement('span');
                text.innerText = folderName;

                labelDiv.appendChild(toggle);
                labelDiv.appendChild(icon);
                labelDiv.appendChild(text);

                labelDiv.onclick = (e) => {
                    if (e.target.className === 'tree-toggle') return;
                    filterByFolder(fullPath, labelDiv);
                };

                nodeDiv.appendChild(labelDiv);

                if (hasChildren) {
                    const childContainer = document.createElement('div');
                    childContainer.className = 'tree-children';
                    renderCollapsibleTree(children, childContainer, fullPath);
                    nodeDiv.appendChild(childContainer);
                }

                container.appendChild(nodeDiv);
            });
        }

        function filterByFolder(path, element) {
            state.currentFolder = path;

            // UI Highlight
            document.querySelectorAll('.tree-label').forEach(el => el.classList.remove('active'));
            if (element) element.classList.add('active');

            refreshListDatasource();
        }

        function refreshListDatasource(searchQuery = "") {
            const tbody = document.getElementById('bookmark-table-body');
            let filtered = state.allBookmarks;

            // 1. Filter by Folder: Exact Match for ALL folders (Strict Non-Recursive)
            if (state.currentFolder) {
                // If "All Bookmarks" is selected, match items with no folder (top level)
                const targetPath = state.currentFolder === "All Bookmarks" ? "" : state.currentFolder;
                filtered = filtered.filter(bm => (bm.folder || "") === targetPath);
            }

            // 2. Filter by Search Query (if any)
            if (searchQuery) {
                const lowQuery = searchQuery.toLowerCase();
                filtered = filtered.filter(bm =>
                    (bm.title && bm.title.toLowerCase().includes(lowQuery)) ||
                    (bm.url && bm.url.toLowerCase().includes(lowQuery))
                );
            }

            // 3. High-Performance Render
            const fragment = document.createDocumentFragment();
            const regex = searchQuery ? new RegExp(`(${searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi') : null;

            filtered.forEach(bm => renderRow(bm, fragment, regex));

            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }

        function renderRow(bm, fragment, regex = null) {
            const tr = document.createElement('tr');
            let statusHtml = '<span style="color:#10b981">‚úì Synced</span>';

            if (bm.status === 'absent_on_source') {
                statusHtml = '<span class="badge" style="background:#ef4444; color:#fff">‚ö†Ô∏è Missing in Source</span>';
                tr.style.opacity = '0.6';
                tr.style.background = 'rgba(239, 68, 68, 0.05)';
            }

            // Highlighting Logic
            let displayTitle = bm.title || "No Title";
            let displayUrl = bm.url;

            if (regex) {
                displayTitle = displayTitle.replace(regex, '<span class="highlight">$1</span>');
                displayUrl = displayUrl.replace(regex, '<span class="highlight">$1</span>');
            }

            // Tags Logic
            let tagsHtml = '';
            if (Array.isArray(bm.tags)) {
                tagsHtml = bm.tags.map(tag => `
                    <span class="tag-pill">
                        ${tag.name}
                        <span class="tag-remove" onclick="removeTag(${bm.id}, ${tag.id})">√ó</span>
                    </span>
                `).join('');
            }

            tr.innerHTML = `
                <td class="col-title" title="${bm.url}">
                    <div style="font-weight:600; overflow:hidden; text-overflow:ellipsis;">${displayTitle}</div>
                    <div style="font-size:0.75rem; opacity:0.5; overflow:hidden; text-overflow:ellipsis;">${displayUrl}</div>
                </td>
                <td class="col-folder">
                    <div style="display:flex; align-items:center; gap:6px; opacity:0.8;">
                        <span style="font-size:0.9rem">üìÇ</span> 
                        <span style="overflow:hidden; text-overflow:ellipsis;" title="${bm.folder || 'Top Level'}">
                            ${bm.folder || '<span style="opacity:0.5; font-style:italic;">Top Level</span>'}
                        </span>
                    </div>
                </td>
                <td class="col-tags">
                    <div style="display:flex; flex-wrap:wrap; gap:4px;">
                        ${tagsHtml}
                    </div>
                    <button class="tag-add-btn" onclick="promptAddTag(${bm.id})">+</button>
                </td>
                <td class="col-source"><span class="source-badge">${bm.source}</span></td>
                <td class="col-status">${statusHtml}</td>
                <td class="col-history" style="text-align:center;">
                    <button class="history-btn" onclick="viewHistory(${bm.id})" title="Version History">üìú</button>
                </td>
            `;
            fragment.appendChild(tr);
        }

        async function viewHistory(id) {
            const modal = document.getElementById('history-modal');
            const list = document.getElementById('history-list');
            list.innerHTML = '<p style="opacity:0.5;">Loading history...</p>';
            modal.style.display = 'flex';

            try {
                const res = await fetch(`${API_BASE}/bookmarks/${id}/history`);
                const data = await res.json();
                list.innerHTML = '';

                if (data.history.length === 0) {
                    list.innerHTML = '<p style="opacity:0.5; padding:2rem; text-align:center;">No previous versions found.</p>';
                    return;
                }

                data.history.forEach(h => {
                    const date = new Date(h.created_at).toLocaleString();
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div>
                            <div style="font-weight:600; font-size:0.85rem;">v${h.version}: ${h.title}</div>
                            <div style="font-size:0.7rem; opacity:0.5;">${date}</div>
                        </div>
                        <button class="btn" style="font-size:0.7rem; padding:4px 8px; background:rgba(56, 189, 248, 0.1); color:var(--accent);" 
                                onclick="revertTo(${id}, ${h.id})">Revert</button>
                    `;
                    list.appendChild(item);
                });
            } catch (e) { list.innerHTML = 'Failed to load history.'; }
        }

        function closeHistory() { document.getElementById('history-modal').style.display = 'none'; }

        async function revertTo(bmId, historyId) {
            if (!confirm("Revert this bookmark to this version?")) return;
            const res = await fetch(`${API_BASE}/bookmarks/${bmId}/revert/${historyId}`, { method: 'POST' });
            if (res.ok) {
                alert("Bookmark reverted!");
                closeHistory();
                refreshList();
            }
        }

        // --- End Folder Logic ---

        async function refreshList() {
            try {
                const res = await fetch(`${API_BASE}/api/bookmarks`);
                const data = await res.json();
                state.allBookmarks = data.bookmarks || data.data || [];

                // Update Tree
                const treeContainer = document.getElementById('folder-tree');
                treeContainer.innerHTML = '';
                const treeRoot = buildFolderTree(state.allBookmarks);
                renderCollapsibleTree(treeRoot, treeContainer);

                // Update Table (respect current folder filter)
                refreshListDatasource();

            } catch (e) { console.error("Load failed", e); }
        }


        init();
    </script>
</body>

</html>